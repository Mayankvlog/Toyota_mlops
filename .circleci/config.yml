version: 2.1

jobs:
  test:
    docker:
      - image: circleci/python:3.8

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            pip install -r requirements.txt

      - run:
          name: Run tests
          command: |
            pytest
            coverage xml -o coverage/coverage.xml

  store-artifacts:
    docker:
      - image: circleci/python:3.8

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Store artifacts
          command: |
            mkdir -p ~/artifacts
            cp scatter_plot.html ~/artifacts
            cp pie_plot.html ~/artifacts
            cp bar_plot.html ~/artifacts
            cp line_plot.html ~/artifacts

      - persist_to_workspace:
          root: ~/artifacts
          paths:
            - .

  deploy:
    docker:
      - image: circleci/python:3.8

    working_directory: ~/repo

    steps:
      - checkout

      - add_ssh_keys:
          fingerprints:
            - "SHA256:5lFrf/UP0g00QTx7+i7SVeYR5cMlBtfzjCGXoJMWXTY"

      - run:
          name: Deploy to production
          command: |
            ssh user@127.0.0.1 "cd /path/to/deployment && git pull origin master && ./deploy.sh"

workflows:
  version: 2

  build-and-deploy:
    jobs:
      - test:
          filters:
            branches:
              only:
                - master

      - store-artifacts:
          filters:
            branches:
              only:
                - master

      - deploy:
          requires:
            - store-artifacts
          filters:
            branches:
              only:
                - master
